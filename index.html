<!DOCTYPE html>

<html>
    <head>
        <title>Word Pacer</title>
         <meta charset="UTF-8"> 
        <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="excanvas.js"></script><![endif]-->
        <script language="javascript" type="text/javascript" src="jquery-2.2.3.min.js"></script>
        <script language="javascript" type="text/javascript" src="markdown-it-6.0.1.js"></script>
        <script language="javascript" type="text/javascript" src="jquery.jqplot.min.js"></script>
        <script language="javascript" type="text/javascript" src="plugins/jqplot.barRenderer.js"></script>
        <script language="javascript" type="text/javascript" src="plugins/jqplot.categoryAxisRenderer.js"></script>
        <script language="javascript" type="text/javascript" src="plugins/jqplot.pointLabels.js"></script>
        <link rel="stylesheet" type="text/css" href="jquery.jqplot.min.css" />
        <script language="javascript" type="text/javascript" src="wordpacer.js"></script>
    </head>

    <body>
        <div class="container">
            <h1>Paste your text in here</h1>
            <p>(Assuming Markdown syntax for the time being)</p>
            <textarea id="source"># Test

One.

Test *test* test. This is a more-than8-characterword. This is a test---right here. Isn't it? It is! "Yeah."

And now, I will totally write a sentence that has more than 15 words in it... for science. Incidentally, the previous sentence had more than 5 sentences.

This is a one-sentence paragraph.
</textarea>
            <p><span id="doit">Analyze Text</span></p>
            <h1>Statistics</h1>
            <div id="result-stats">
                <ul>
                    <li>Words:                   <span id="wordcount">     </span></li>
                    <li>Sentences:               <span id="sentcount">     </span></li>
                    <li>Paragraphs:              <span id="paracount">    </span></li>
                    <li>Average word length:     <span id="avg_wordlength"></span></li>
                    <li>Minimum reader velocity: <span id="min_velocity">  </span></li>
                    <li>Maximum reader velocity: <span id="max_velocity">  </span></li>
                    <li>Average reader velocity: <span id="avg_velocity">  </span></li>
                </ul>
            </div>
            <hr />
            <div id="info"></div>
            <div id="wordchart"></div>
            <hr />
            <div id="result-html"></div>
            <hr />
            <h1>Debugging</h1>
            <pre><div id="debug"></div></pre>
        </div>
    </body>

<script type="text/javascript">
$(document).ready(function () {
    var md = window.markdownit({typographer: true});

    $('#doit').click(function () {
        var html = md.render($('#source').val());
        $('#result-html').html(html);

        var text = strip(html); // Get plain text XXX assumes Markdown -> HTML
        wordData = gatherData(text);
        var stats = {
            avgWordlength: (wordData.wordlengths.reduce(function(sum, x) {return sum + x}, 0)) / wordData.wordlengths.length,
            minVelocity: Math.min.apply(null, wordData.velocities),
            maxVelocity: Math.max.apply(null, wordData.velocities),
            avgVelocity: (wordData.velocities.reduce(function(sum, x) {return sum + x;}, 0)) / wordData.velocities.length
        };
        $('#result-stats #wordcount').html(wordData.wordcount);
        $('#result-stats #sentcount').html(wordData.sentcount);
        $('#result-stats #paracount').html(wordData.paracount);
        $('#result-stats #avg_wordlength').html(stats.avgWordlength);
        $('#result-stats #min_velocity').html(stats.minVelocity);
        $('#result-stats #max_velocity').html(stats.maxVelocity);
        $('#result-stats #avg_velocity').html(stats.avgVelocity);
        //console.log(wordData.wordlengths, wordData.velocities, wordData.wordticks, stats); //DEBUG

        var ticks = Array.apply(null, Array(wordData.wordcount + 2)).map(function(_, i) {return i;}); // the +2 is needed
        ticks.splice(0, 1); // Remove from tick series XXX (necessary?)
        var wordCombo = [];
        for (var i = 0; i < wordData.wordticks.length; i++) {
            wordCombo[i] = [];
            for (var j = 0; j < wordData.wordticks[i].length; j++) {
                wordCombo[i][j] = [wordData.wordticks[i][j], wordData.wordlengths[i][j], wordData.allWords[i][j]];
            }
        }
        //console.log(wordCombo) //DEBUG
        $.jqplot.config.enablePlugins = true;
        var plot1 = $.jqplot('wordchart', wordCombo, {
            seriesColors: ['#99a', '#ccd'],
            seriesDefaults: {
                renderer: $.jqplot.BarRenderer,
                rendererOptions: {
                    barWidth: 15,
                    barPadding: -15,
                    barMargin: 0
                },
                pointLabels: { show: true },
            },
            axes: {
                xaxis: {
                    renderer: $.jqplot.CategoryAxisRenderer,
                    ticks: ticks
                }
            },
            highlighter: { show: false }
        });

        $('#wordchart').bind('jqplotDataClick',
            function (ev, seriesIndex, pointIndex, data) {
                $('#info').html('series: '+seriesIndex+', point: '+pointIndex+', data: '+data);
            }
        );
        plot1.replot({ resetAxes: true });
        $('#debug').html(text); //DEBUG
    });
});
</script>
</html>
